#!/usr/bin/make -f

include /usr/share/linux-packaging-snippets/kernel-snippet.mk

%:
	dh $@

debian/control:
	# Override to enable aarch64 host compat
	sed -e "s|@KERNEL_BASE_VERSION@|$(KERNEL_BASE_VERSION)|g" \
		-e "s|@VARIANT@|$(VARIANT)|g" \
		-e "s|@DEVICE_VENDOR@|$(DEVICE_VENDOR)|g" \
		-e "s|@DEVICE_MODEL@|$(DEVICE_MODEL)|g" \
		-e "s|@DEVICE_FULL_NAME@|$(DEVICE_FULL_NAME)|g" \
		-e "s|@DEB_TOOLCHAIN@|$(DEB_TOOLCHAIN)|g" \
		-e "s|@DEB_BUILD_ON@|$(DEB_BUILD_ON)|g" \
		-e "s|@DEB_BUILD_FOR@|$(DEB_BUILD_FOR)|g" \
		/usr/share/linux-packaging-snippets/control.in > debian/control
	# Remove python prebuilt from control for aarch64
	@HOST_ARCH=$$(uname -m); \
	if [ "$$HOST_ARCH" = "aarch64" ]; then \
		sed -i '/android-platform-prebuilts-python-linux-x86-2.7.5,/d' debian/control; \
	fi

path-override-prepare:
	# Override to adapt aarch64 host compat.
	# Requires removing x86_64 python prebuilt from control
	mkdir -p debian/path-override
	ln -sf /usr/bin/python debian/path-override/python
	ln -sf /usr/bin/python debian/path-override/python2
	ln -sf /usr/bin/python debian/path-override/python2.7

# Because vayu want use a bookworm based initram
out/KERNEL_OBJ/initramfs.gz:
	OVERLAY_DIR="$(CURDIR)/debian/initramfs-overlay"; \
        if [ ! -e "$${OVERLAY_DIR}" ]; then \
                mkdir -p $${OVERLAY_DIR}; \
        fi; \
        tmpdir=$$(mktemp -d); \
        ( \
                cd $${tmpdir}; \
                echo "Downloading initram boot scripts..."; \
                git clone -b sid https://github.com/droidian-berb/initramfs-droidian-boot-scripts; \
                rm -rf initramfs-droidian-boot-scripts/.git; \
                cp -av initramfs-droidian-boot-scripts/* $${OVERLAY_DIR}; \
                rm -r initramfs-droidian-boot-scripts; \
                echo "Downloading initram template..."; \
                wget -q -O ./initram.img-droidian-arm64 https://github.com/droidian-berb/initramfs-droidian-skels/raw/refs/heads/droidian/initramfs-droidian-bookworm-nominienv-arm64-skel_v2; \
                gunzip -c initram.img-droidian-arm64 | cpio -i; \
                rm -f initram.img-droidian-arm64; \
                cp -Rv $${OVERLAY_DIR}/* .; \
                find . | cpio -o -R 0:0 -H newc | gzip > $(BASEDIR)/$@; \
        ); \
        rm -rf $${tmpdir}
